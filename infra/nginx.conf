# Rate limiting zone - 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=ryanjh_limit:10m rate=10r/s;

# Gzip compression
gzip on;
gzip_vary on;
gzip_comp_level 5;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
gzip_min_length 256;

# Brotli compression
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;

# FastCGI cache configuration
fastcgi_cache_path /var/cache/nginx/ryanjh.com
    levels=1:2
    keys_zone=ryanjh_cache:10m
    max_size=1g
    inactive=60m
    use_temp_path=off;

# FastCGI cache key
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Map for Symfony session detection (cache bypass)
map $http_cookie $no_cache {
    default 0;
    "~*PHPSESSID" 1;
    "~*POST" 1;
}

# File cache for improved performance with try_files
open_file_cache max=1000 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# non-www to www redirect
server {
    listen 443 ssl;
    http2 on;
    server_name ryanjh.com;

    ssl_certificate /etc/letsencrypt/live/ryanjh.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ryanjh.com/privkey.pem;

    return 301 https://www.ryanjh.com$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl;
    http2 on;
    server_name www.ryanjh.com;

    # Document root - served directly by Nginx
    root /srv/ryanjh/public;

    # Default index
    index index.php;

    # SSL certificates (managed by certbot)
    ssl_certificate /etc/letsencrypt/live/ryanjh.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ryanjh.com/privkey.pem;

    # SSL hardening
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;

    # Rate limiting (10 requests per second per IP, burst of 20)
    limit_req zone=ryanjh_limit burst=20 nodelay;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; font-src 'self' *.bunny.net bunny.net;" always;

    # Logging
    access_log /var/log/nginx/ryanjh.com-access.log;
    error_log /var/log/nginx/ryanjh.com-error.log;

    # Static assets - served directly by Nginx with aggressive caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        access_log off;

        # Try file, fallback to index.php (for AssetMapper routes)
        try_files $uri /index.php$is_args$args;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to sensitive Symfony files
    location ~ ^/(config|var|vendor|bin|templates)/ {
        deny all;
    }

    # PHP-FPM handler for index.php
    location ~ ^/index\.php(/|$) {
        # FastCGI pass to PHP-FPM in container
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        # Include default FastCGI params
        include fastcgi_params;

        # Symfony-specific FastCGI params
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Trusted proxy headers for Symfony
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
        fastcgi_param HTTP_X_FORWARDED_HOST $host;
        fastcgi_param HTTP_X_FORWARDED_PORT $server_port;

        # FastCGI performance tuning
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        # FastCGI caching
        fastcgi_cache ryanjh_cache;
        fastcgi_cache_valid 200 1h;
        fastcgi_cache_valid 301 302 1h;
        fastcgi_cache_valid any 10m;
        fastcgi_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        fastcgi_cache_lock on;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock_timeout 5s;

        # Cache bypass for sessions and POST requests
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;

        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; font-src 'self' *.bunny.net bunny.net;" always;

        # Internal only (prevents direct access to index.php)
        internal;
    }

    # Symfony front controller pattern
    location / {
        # Try to serve file directly, fallback to index.php
        try_files $uri /index.php$is_args$args;
    }

    # Deny access to other PHP files (security)
    location ~ \.php$ {
        return 404;
    }
}
