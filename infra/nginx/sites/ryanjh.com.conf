# Nginx configuration for https://www.ryanjh.com

# Redirect HTTP -> HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name ryanjh.com www.ryanjh.com;

    # Let's Encrypt ACME challenge
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Redirect everything else to HTTPS
    location / {
        return 308 https://$host$request_uri;
    }
}

upstream php-fpm {
    server ryanjh:9000;
    keepalive 8;
}

# Redirect non-www to www
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name ryanjh.com;

    # Let's Encrypt SSL certificate
    ssl_certificate /etc/letsencrypt/live/ryanjh.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ryanjh.com/privkey.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers on;

    return 301 https://www.ryanjh.com$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name www.ryanjh.com;

    # Let's Encrypt SSL certificate
    ssl_certificate /etc/letsencrypt/live/ryanjh.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ryanjh.com/privkey.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' data:; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; font-src 'self'; img-src 'self' data:; connect-src 'self';" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Rate limiting
    limit_req zone=general burst=60 nodelay;
    limit_req_status 429;
    limit_conn addr 20;

    # Logging
    access_log /var/log/nginx/ryanjh.access.log main;
    error_log /var/log/nginx/ryanjh.error.log warn;

    # Serve user uploads directly
    location ^~ /uploads/ {
        alias /var/www/html/ryanjh/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;

        # Prevent PHP execution in uploads
        location ~ \.php$ {
            deny all;
        }
    }

    # Serve assets and bundles with caching
    location ~ ^/(assets|bundles)/ {
        root /var/www/html/ryanjh/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # Deny access to sensitive Symfony files
    location ~ ^/(config|var|vendor|bin|templates|src|tests|migrations)/ {
        deny all;
        return 404;
    }

    # Block hidden files and composer files
    location ~ /\.|composer\.(json|lock)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # Deny access to other PHP files
    location ~ \.php$ {
        deny all;
        return 404;
    }

    # Everything else goes to PHP-FPM
    location / {
        # Try to serve file directly, otherwise pass to PHP
        try_files $uri @symfony;
    }

    # Symfony front controller
    location @symfony {
        # FastCGI cache settings
        fastcgi_cache symfony_cache;
        fastcgi_cache_valid 200 60m;  # Cache successful responses for 60 minutes
        fastcgi_cache_valid 404 10m;  # Cache 404s for 10 minutes
        fastcgi_cache_bypass $http_pragma $http_authorization;  # Bypass for logged-in users
        fastcgi_no_cache $http_pragma $http_authorization;

        # Cache pages regardless of what Symfony says.
        fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

        # Don't cache if logged in
        set $no_cache 0;
        if ($http_cookie ~* "PHPSESSID") {
                set $no_cache 1;
        }
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;

        # Add cache status header
        add_header X-Cache-Status $upstream_cache_status;

        fastcgi_pass php-fpm;
        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME /app/public/index.php;
        fastcgi_param DOCUMENT_ROOT /app/public;
        fastcgi_param SCRIPT_NAME /index.php;

        # Pass original request info
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;

        # Symfony reverse proxy headers
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
        fastcgi_param HTTP_X_FORWARDED_HOST $host;
        fastcgi_param HTTP_X_FORWARDED_PORT $server_port;
        fastcgi_param HTTPS $https if_not_empty;

        # Connection settings
        fastcgi_keep_conn on;
        fastcgi_intercept_errors off;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;

        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        fastcgi_hide_header X-Powered-By;
    }

    # Explicitly handle index.php (Symfony front controller)
    location ~ ^/index\.php(/|$) {
        fastcgi_pass php-fpm;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME /app/public/index.php;
        fastcgi_param DOCUMENT_ROOT /app/public;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Symfony reverse proxy headers
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
        fastcgi_param HTTP_X_FORWARDED_HOST $host;
        fastcgi_param HTTP_X_FORWARDED_PORT $server_port;
        fastcgi_param HTTPS $https if_not_empty;

        fastcgi_hide_header X-Powered-By;
        internal;
    }
}
